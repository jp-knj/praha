# 本番稼働中のデータベースをマイグレーションしよう
[課題内容](https://airtable.com/appPxhCPFYGqqN9YU/tblVlFr2q4lIqDKYc/viwX8r6DpCRp80swL/recdCiVLaoXjOSK64?blocks=hide)

## 課題1
- Q.「expand and contract pattern」です。どのような手法なのか、説明してみてください
  - A. Expand and Contract Patternとは、一度のマイグレーションで全てのDDL文を実行するのではなく、複数回に分けてマイグレーションを実施し、段階的に更新を行う手法です。まずは、古いスキーマから新しいスキーマへ変更を行う際に「Expand」と呼ばれる過程を行います。Expandでは、古いスキーマのテーブルに新しいカラムを追加したり、変更したりするなど、現在のテーブルを拡張します。拡張が完了したら、「Contract」と呼ばれる過程を行います。Contractでは、古いスキーマを新しいスキーマに変更するため、古いカラムを削除したり、変更したりするなど、新しいスキーマへと変更を行います。ExpandとContractを繰り返していくことで、データベースのスキーマを段階的に更新していくことができます。これにより、一度のマイグレーションで全てのDDL文を実行するよりも、ダウンタイムを最小限に抑えながら、段階的に更新を行うことが可能となります。
- Q.開発環境でマイグレーションを実施した時は問題なかったのに、本番環境で実施したら失敗することが時々あります。特に既存テーブルのカラムにNOT NULL制約を追加する時によく起きるのですが、何故でしょうか？この失敗を避けるためには、どのような対策が有効でしょうか？
  - A.NOT NULL制約を追加する際、テーブルに既にNULL値が存在している場合、NOT NULL制約の追加が失敗してしまいます。このような場合においては、まずNULL値を除去する必要があります。NULL値を除去するためには、テーブル内のNULL値を各値のデフォルト値などで置換するなどの対応を行います。また、NULL値を除去した後、NOT NULL制約の追加を行う前に、本番環境で事前にテストを行うなど、実施前に確認を行うことも大切です。
- Q.マイグレーションの作業手順書を作成してください。最低限以下の点を抑えておきましょう！
    - 実行手順をステップごとに細かく列挙
      - 例：本番環境で実行するコマンドは作業手順書からコピペするだけで完結するような状態になっていると良いですね！（コピペしたコマンドを全て開発環境で一度実行して動作確認まで済ませていると最高）
    - 発生しうる問題
    - 問題が発生したときの対応策
- A.マイグレーションの作業手順書
    - 1. 作業を開始する前に、本番環境のデータベースをバックアップする。
    - 2. 開発環境でマイグレーションを実施して、コマンドを実行して確認する。
    - 3. 本番環境でマイグレーションを実施する。
        - 1. 本番環境のマイグレーションコマンドを開発環境と同じものをコピーする。
        - 2. 本番環境でマイグレーションを実行する。
    - 4. マイグレーションが正常に完了したかどうかを、DBの状態を確認して確認する。
    - 5. マイグレーションを完了したら、アプリケーションを再起動して動作確認を行う。 
  ■ 発生しうる問題 
    - NOT NULL 制約を追加する際、既存テーブルにNULL値が存在する場合、NOT NULL制約の追加が失敗する。 
  ■ 対応策 
    - NULL値を除去するために、テーブル内のNULL値を各値のデフォルト値などで置換する。 
    - NOT NULL制約を追加する前に、実施前に本番環境でテストを行う。