# DDDを学ぶ（応用）
[課題内容](https://airtable.com/appPxhCPFYGqqN9YU/tblVlFr2q4lIqDKYc/viwX8r6DpCRp80swL/recdP3b322G3fZT2i?blocks=hide)

## 課題1

Q.このようなアクセス制御ロジックはオニオンアーキテクチャのどの層に実装するべきでしょうか？

A.ユースケース層に実装するべき。(ドメインオブジェクトを使用するサービス層やユースケース層でアクセスを制限する)
理由として、
- 「セキュリティ上の懸念はドメイン外で処理されるべきである」ため
- アクセス制御ロジックは、ユースケースやユーザフローに依存するため
- ユースケースクラスから明示的に認証サービスにユーザー情報を取りにいくようにするのがsimple。
- 取得するためのオブジェクトとしては、SomethingPepositoryのようなで外部サービスということを隠蔽。

| レイヤ                 | セキュリティ対策                                    |
|---------------------|---------------------------------------------|
| client / controller | 認証、Webページ(URL)単位での認可                        |
| ファサード               | ロールベースの認可                                   |
| ドメイン                | ドメイン・インスタンス単位での認可、ACL                       |
| データベース              | DBオブジェクト単位の認可(ストアド・プロシージャ、ストアド・ファンクション、トリガ) |

#### 参考文献
[ドメイン駆動設計でのアクセス制御](https://www.web-dev-qa-db-ja.com/ja/security/%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E9%A7%86%E5%8B%95%E8%A8%AD%E8%A8%88%E3%81%A7%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E5%88%B6%E5%BE%A1/1046067189/)
[ユーザーと権限](https://www.web-dev-qa-db-ja.com/ja/domain-driven-design/ddd%E3%81%AE%E5%AE%9F%E8%A3%85%EF%BC%9A%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%A8%E6%A8%A9%E9%99%90/l967071491/)
[ドメイン駆動設計・開発の実践](https://www.infoq.com/jp/articles/ddd-in-practice/)

Q.Userクラスに「isLoggedIn」という属性が定義されているのをみた別のエンジニアが、「emailAddress」や「firebaseUserId」など、認証に関わるような属性を追加するPRを提出しました
果たしてUserエンティティに上記のようなプロパティを増やすことに問題はないのでしょうか？

A.問題がありそうです。
Userエンティティには、ドメイン上のUserにまつわる情報を持つことを期待しています。（名前やメールアドレスなど）
そのため、Webアプリケーションのコンテキスト上のUserにまつわる情報を持つことは期待していない。（認証やユーザ証明に関するものになる。）

#### 参考文献
[コンテキストマッピングによる戦略的ドメイン駆動設計](https://www.infoq.com/jp/articles/ddd-contextmapping_jp/)

Q. どのように実装すれば、複数集約の整合性が担保されると思いますか？
「タスク」と「活動レポート」二つの集約の整合性を保つ必要があるケースを想定。
例えば「タスク」と「活動レポート」の集約があり、タスクを作成したら必ず「タスクを作成しました」と活動レポートを作成しなければいけないとします

A.複数集約間の整合性確保するための実装として
1. ユースケースで複数集約を更新(2つの集約を更新)  
**Con:**「タスクを作成したら、活動レポートを作成する」ということはドメイン層の知識として重要であるが、ドメイン層には記述されていない。
2. ドメインサービスを使用  
**Con:** ドメイン層の「サービス」の濫用を招き、ファットなドメインサービス、ドメインモデル貧血症なエンティティ・値オブジェクトを誘発する可能性があること。
3. ドメインイベントを使用(ドメインイベントはよくわかっていない)

<details>
    <summary>ドメインイベントとは</summary>
    あるドメインで発生する出来事を表現したもの。
    ドメインの中では、「〜が行われた時」や「もし〜になったら」といったような特定の出来事の発生を契機ににつの何かを行うことがある。
</details>

ブログを投稿できるWEBサービスで、ブログの文字数が上限の1000文字を超えたらエラーが生じるようにしたいと考えました。とあるエンジニアが以下のようなコードを提出しました  

[Github gist](https://gist.github.com/Dowanna/6519efa3f5cd3b40995e1e7eda44853a)

Q.文字数の上限を超えた際にエラーをthrowすることに関して、どのような問題が起き得ると思いますか？ 
思わぬ、例外が発生で`try/catch`を書かなければならない。
別の開発者が、`new Post`をして、`text`を渡して、予期せぬ例外が発生することを確認される。

#### 参考文献
[コンストラクタが例外をスローする場合には細心の注意を](https://www.jpcert.or.jp/java-rules/obj11-j.html)  

**food for thought 1**  
エラーをthrowする以外に、どのような設計パターンが考えられるでしょうか？例えばGo言語であれば、戻り値の第2引数にエラー型のオブジェクトを返すような設計がよく見られます。

#### Result型を利用
Result型を作成し、エラーを返すようにします。
```rust
pub enum Result<T, E> {
    Ok(T),
    Err(E),
}
```

`.?`オペレーターを追加
Resultを返す式の最後に?を書くと、`Ok(T)`ならばTの値を返し、`Err(E)`ならば`Err(E)`を`return`してくれるという機能。
また単に`Err(E)`を`return`するだけではなく、関数の戻り値型が`Result<T, E2>`の時に`From::from`による型変換も自動的に行う。