# DDDを学ぶ（応用）
[課題内容](https://airtable.com/appPxhCPFYGqqN9YU/tblVlFr2q4lIqDKYc/viwX8r6DpCRp80swL/recdP3b322G3fZT2i?blocks=hide)

## 課題1

Q.このようなアクセス制御ロジックはオニオンアーキテクチャのどの層に実装するべきでしょうか？
ユースケース層に実装すべき。(ドメインオブジェクトを使用するサービス層やユースケース層でアクセスを制限する)
理由として、
- 「セキュリティ上の懸念はドメイン外で処理されるべきである」ため
- アクセス制御ロジックは、ユースケースやユーザフローに依存するため

| レイヤ                 | セキュリティ対策                                    |
|---------------------|---------------------------------------------|
| client / controller | 認証、Webページ(URL)単位での認可                        |
| ファサード               | ロールベースの認可                                   |
| ドメイン                | ドメイン・インスタンス単位での認可、ACL                       |
| データベース              | DBオブジェクト単位の認可(ストアド・プロシージャ、ストアド・ファンクション、トリガ) |

#### 参考文献
[ドメイン駆動設計でのアクセス制御](https://www.web-dev-qa-db-ja.com/ja/security/%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E9%A7%86%E5%8B%95%E8%A8%AD%E8%A8%88%E3%81%A7%E3%81%AE%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E5%88%B6%E5%BE%A1/1046067189/)
[ユーザーと権限](https://www.web-dev-qa-db-ja.com/ja/domain-driven-design/ddd%E3%81%AE%E5%AE%9F%E8%A3%85%EF%BC%9A%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%A8%E6%A8%A9%E9%99%90/l967071491/)
[ドメイン駆動設計・開発の実践](https://www.infoq.com/jp/articles/ddd-in-practice/)


Q.Userクラスに「isLoggedIn」という属性が定義されているのをみた別のエンジニアが、「emailAddress」や「firebaseUserId」など、認証に関わるような属性を追加するPRを提出しました
果たしてUserエンティティに上記のようなプロパティを増やすことに問題はないのでしょうか？
-「認証コンテキスト」
- 「アクセスコンテキスト」
- 「DDD 認証」

Q. どのように実装すれば、複数集約の整合性が担保されると思いますか？
「タスク」と「活動レポート」二つの集約の整合性を保つ必要があるケースを想定してみます
例えば「タスク」と「活動レポート」の集約があり、タスクを作成したら必ず「タスクを作成しました」と活動レポートを作成しなければいけないとします
ヒント：「元の記事では複数の集約をトランザクションで横断する方法」を紹介していますが、「そもそも複数の集約を強い整合性で担保するのは違和感がある」と指摘する記事もあります
それぞれの主張を理解しつつ、ペアで結論を出してみましょう！


ブログを投稿できるWEBサービスで、ブログの文字数が上限の1000文字を超えたらエラーが生じるようにしたいと考えました。とあるエンジニアが以下のようなコードを提出しました：
[Github gist](https://gist.github.com/Dowanna/6519efa3f5cd3b40995e1e7eda44853a)
Q.文字数の上限を超えた際にエラーをthrowすることに関して、どのような問題が起き得ると思いますか？
**food for thought 1**  
エラーをthrowする以外に、どのような設計パターンが考えられるでしょうか？例えばGo言語であれば、戻り値の第2引数にエラー型のオブジェクトを返すような設計がよく見られます。

**food for thought 2**  
関数型プログラミングの世界には「モナド」と呼ばれる概念があります。これを活用する方法はないでしょうか？「Result型」などのワードで検索してみても良いかもしれません
