# データベース設計のアンチパターンを学ぶ8

## 課題1
**Q.** この対応にはどのような問題点が潜んでいるでしょうか？
A. 
1. サイクリックに使いまわされる
   1. A000 ~ F999 までの登録コードを格納してしまうと、次の登録コードを格納できなくなってしまう
2. 途中で指す対象が変化する
   1. `ネジ`、`ボルト`は単体で登録されることがなくなり,ボルトは`ネジ`として登録コードを管理することになった場合、履歴管理はしづらくなってしまう。

**変更前**

| productCode | name | numbers | 
|-------------|------|---------|
| A106        | ネジ　  | 100     |
| F980        | ボルト　 | 100     |

**変更後** (セット前とセット後の情報を分けて履歴管理することが望ましかったが、このDB設計だと難しい)

| productCode | name | numbers | 
|-------------|------|---------|
| A106        | ネジ　  | 200 |

## 課題2 
A.代理キーによる解決
- 代理キーとして、`productCode`という整数型の代理キーを追加する

| productCode | name | numbers | 
|-------------|------|---------|
| 999         | ネジ　  | 200 |
| 1000        | ボルト　 | 200 |
**注意** : 代理キーの使用は控えて、自然キーを使用する
なぜ、代理キーを積極的に使用しないのか？
- 業務的には不要なキーであるため、代理キーが何の役割を果たしているのかはER図からは分かりにくいため

- GUID を使用する
参考書籍:[SQLアンチパターン](https://www.amazon.co.jp/SQL%E3%82%A2%E3%83%B3%E3%83%81%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3-Bill-Karwin/dp/4873115892/ref=sr_1_1?adgrpid=109803904931&hvadid=447890863675&hvdev=c&hvlocphy=20658&hvnetw=g&hvqmt=e&hvrand=6688891964038825011&hvtargid=kwd-335484809678&hydadcr=27264_11561110&jp-ad-ap=0&keywords=sql%E3%82%A2%E3%83%B3%E3%83%81%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3&qid=1641821614&sr=8-1)
A.自然キーによる解決
- 自然キーに主キーが存在しない場合、業務仕様を調節する。アプリケーションで一意になるよう整形する対策(捨て案)
- タイムスタンプ(時点)を利用する
year時点のデータであるかを示すタイムスタンプがあれば、直近の情報ではなく、過去に遡ってデータを取得できる

| year | productCode | name | numbers |
|------|-------------|------|---------|
| 2021 | A106        | ネジ　  | 100     |
| 2021 | F980        | ボルト　 | 100     |
| 2022 | A106        | ネジ   | 200     |

- インターバル(期間)を利用する
- スナップショット別にデータを持つ必要はなく、データの有効期限を入力するだけなので、全体としてレコード数を少なく抑えられる

| start_year | end_year | productCode | name | numbers |
|------------|----------|-------------|------|---------|
| 2021       | 9999     | ネジ　  | ネジ  |  100       |
| 2020       | 2021     | ボルト　 | ボルト  | 100        |
| 2022       | 9999     | ネジ   | ネジ  |200|

## 課題3


参考書籍:[達人に学ぶ DB設計 徹底指南書](https://~ww.amazon.co.jp/%E9%81%94%E4%BA%BA%E3%81%AB%E5%AD%A6%E3%81%B6SQL%E5%BE%B9%E5%BA%95%E6%8C%87%E5%8D%97%E6%9B%B8-%E7%AC%AC2%E7%89%88-%E5%88%9D%E7%B4%9A%E8%80%85%E3%81%A7%E7%B5%82%E3%82%8F%E3%82%8A%E3%81%9F%E3%81%8F%E3%81%AA%E3%81%84%E3%81%82%E3%81%AA%E3%81%9F%E3%81%B8-%E3%83%9F%E3%83%83%E3%82%AF-ebook/dp/B07GB4CNKP/ref=sr_1_1?adgrpid=103634349349&hvadid=553836646734&hvdev=c&hvlocphy=20658&hvnetw=g&hvqmt=e&hvrand=10474451211937597539&hvtargid=kwd-337667655732&hydadcr=4075_13159862&jp-ad-ap=0&keywords=%E9%81%94%E4%BA%BA%E3%81%AB%E5%AD%A6%E3%81%B6sql%E5%BE%B9%E5%BA%95%E6%8C%87%E5%8D%97%E6%9B%B8&qid=1641816098&sr=8-1)
