# クッキーを理解する
[課題内容](https://airtable.com/appPxhCPFYGqqN9YU/tblVlFr2q4lIqDKYc/viwX8r6DpCRp80swL/recK3c8nSvVp6OaYY?blocks=hide)

## 課題１
- クッキーとはなんでしょうか？
  - ウェブサイトの情報をブラウザに保存する仕組みのこと
    - 適切に名付けられた Set-Cookie ヘッダーをサーバはレスポンスで送信することによって Cookie を設定します。


- www.hoge.comで発行されたクッキーは、www.fuga.comにも送信されるでしょうか？
  - その理由を説明してください
    - 送信はできない
      - `www.`(サブドメイン)は一致しても `hoge.com`,`fuga.com`(ドメイン)は異なっているから
      - 送信時にDomain属性の働きがあるため。Domain属性は「設定された値と送信先のサーバのドメインがマッチするときにだけCookieを送信できる」役割を持っている。
      - Domain属性が存在しないと、悪意のあるサーバから攻撃対象のサーバに送信されるCookieを自由に設定できると、セッション固定攻撃の要因になるため。

[RFC](https://www.rfc-editor.org/rfc/rfc6265#section-5.1.3)

- hoge.com:8080のクッキーはhoge.com:9090にも送信されるでしょうか？
  - 送信はできる
    - > Cookies do not provide isolation by port.
    - ポート番号は分離されないため

[RFC](https://www.rfc-editor.org/rfc/rfc6265#section-8.5)

- www.hoge.comで発行されたクッキーは、www.api.hoge.comにも送信されるでしょうか？
  - 送信はできる
  - 先頭の`%x2E`（ "." ） は、 在っても無視されることがあるため

[RFC](https://www.rfc-editor.org/rfc/rfc6265#section-4.1.2.3)

- クッキーにDomain="hoge.com"を指定した場合、api.hoge.comにもクッキーは送信されるでしょうか？
  - 理由を説明してください
  - Domainが指定された場合、サブドメインは常に含まれるため
    - 具体例
    - `Domain=mozilla.org` を設定すると、`developer.mozilla.org` のようなサブドメインも含まれる。

[MDN](https://developer.mozilla.org/ja/docs/Web/HTTP/Cookies#cookie_%E3%81%AE%E9%80%81%E4%BF%A1%E5%85%88%E3%81%AE%E5%AE%9A%E7%BE%A9)

- ブラウザで実行されるJavaScriptは場合によってはクッキーの値を取得できます。JavaScriptからクッキーの値が取得されることを防ぐことは可能でしょうか？
  - どうすれば良いのでしょうか？
  - `HTTPOnly`属性を追加する
    - JavaScript の Document.cookie API にはアクセスできません。サーバーに送信されるだけです。例えば、サーバー側のセッションを持続させる Cookie は JavaScript が利用する必要はない。
    - この予防策は、クロスサイトスクリプティング (XSS) 攻撃を緩和するのに役立つ

- HTTPS（暗号化）通信の時だけクッキーを送信することは可能でしょうか？
  - どうすれば良いのでしょうか？
  - `Secure`属性を追加する
    - HTTPS プロトコル上の暗号化されたリクエストでのみサーバーに送信され、安全でない HTTP では決して送信されないため、中間者攻撃者が簡単にアクセスすることはできません。

- クッキーにExpiresを設定すると、どのように挙動が変わるでしょうか？
  - クライアントは、Expires に指定された期限内であればキャッシュが「新鮮」ということで、強制的にキャッシュを利用。リクエストを一切送信しなくなります。

- SameSite属性について説明してください
  - XSRF (クロスサイトリクエストフォージェリ)攻撃から保護するための、もう1つのセキュリティオプションです。
    - 具体例
      - あなたはサイト bank.com にログインしました。つまり:あなたはそのサイトからの認証 Cookie を持っています。ブラウザは、あなたを認識して、すべての慎重に扱うべき金融操作を実行するために、リクエスト毎に Cookie を bank.com に送信します。
      - いま、別のウィンドウで Web をブラウジングしていると、別のサイト evil.com にやってきました。そして、それはハッカーのアカウントを持つ <form action="https://bank.com/pay"> と、自動的にサブミットする JavaScript コードを持っています。 
      - そのフォームは evil.com から直接銀行のサイトに送信され、あなたの Cookie も送信されます。なぜなら、あなたが bank.com に訪れるたびに送信されるからです。そのため、銀行はあなたを認識し、実際に支払いを実行します。
  
  - `SameSite`属性は主に２つ値がある
    - `Lax`: samesite=lax の Cookie は、これらの条件が両方とも true の場合に送信されます。
      - HTTP メソッドが “安全” である(e.g. POST ではなく GET)。 安全なHTTP メソッドの完全なリストは `RFC7231 specification` にあります。
      - 基本的に、これらはデータの読み取りのために使用され、データ書き込みには使用するべきでないメソッドです。データ変更操作を実行してはいけません。リンクをたどることは、常にGET(安全なメソッド)です。 
      - 操作は最上位のナビゲーションで実行される(ブラウザのアドレスバーの URL を変更する)。これは通常 `true` ですが、ナビゲーションが <iframe> で実行された場合、これは最上位ではありません。また、AJAX リクエストはどのナビゲーションも行わないため、この条件にはマッチしません。 
      - `samesite=lax` が行うことは、基本的に最も一般的な “URL を開く” という操作で `Cookie` を利用できるようにすることです。
    - `Strict`: ユーザがサイトの外からきた場合、`samesite=strict` を持つ `Cookie` は決して送信されません。 
      - 言い換えると、ユーザがメールにあるリンクを辿った場合や、`evil.com` からのフォームを送信した場合、あるいは他のドメインから生じたサイトに関する任意の操作をした場合、`Cookie` は送信されません。 
      - そして、`XSRF 攻撃`は失敗します。なぜなら、`bank.com` は `Cookie` がないのでユーザを認識せず、支払いには進めないでしょう。 この保護はとても信頼できます。bank.com からの操作のみ samesite の Cookie を送信します。

- クッキーに格納しない方が良い情報の例を、3つ以上挙げてください
  - システム側で必要になってくるID
  - 個人情報、センシティブな情報
  - 4キロバイトを超えるデータ
  
※「認証した」記録や、消えても問題がない情報を格納するのに Cookie は適している。

- クッキーはローカルストレージと混同されることが多々あります。
  - クッキーを使うべきタイミングについて
    - サーバーとクライアントの両方からアクセス可能なデータを保存する必要がある場合は、クッキーを使用します。
      - それ以外の場合は、ローカルストレージを使用します。
      
  - ローカルストレージを使うべきタイミングについて
    - より大きなデータを保存する必要がある場合は、ローカルストレージを使用する。
    - 期限切れにならないデータを保存する必要がある場合は、ローカルストレージを使用します。
    - クライアントに保存されたデータにアクセスし、変更するための使いやすい方法が必要な場合、ローカルストレージを使用します。

    
- Stack OverflowのようなWEB掲示板サービスを開発しているとしましょう。XSS（クロスサイトスクリプティング）により、他ユーザのクッキー情報が抜き出される仕組みを説明してください。
  - どのような対策が考えられますか？
    - Cookie を　`httpOnly`属性を追加する
      - JavaScript からアクセスできない情報には触れることができないため、JavaScriptによるセッショントークン漏洩の危険を減らすことができる。
    -　`Cotent-Security-Policyヘッダー`で機能を細かくON/OFFする
    -　CORS をする 